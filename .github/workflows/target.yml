name: OpenWrt å›ºä»¶æ‰‹åŠ¨äº‘ç¼–è¯‘

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'è¯·è¾“å…¥è¦ç¼–è¯‘çš„å›ºä»¶åç§°'
        required: true
        default: 'K2P'

jobs:
  build:
    runs-on: ubuntu-18.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: æ£€å‡ºæºç 
        uses: actions/checkout@main
      
      - name: ç¯å¢ƒå˜é‡é…ç½®
        run: |
          source ${{ github.workspace }}/config/${{ github.event.inputs.target }}/settings.ini
          echo "REPO_URL=$REPO_URL" >> $GITHUB_ENV
          echo "REPO_BRANCH=$REPO_BRANCH" >> $GITHUB_ENV
          echo "SSH_ACTIONS=$SSH_ACTIONS" >> $GITHUB_ENV
          echo "UPLOAD=$UPLOAD" >> $GITHUB_ENV
          echo "RELEASE=$RELEASE" >> $GITHUB_ENV
          echo "WECHAT=$WECHAT" >> $GITHUB_ENV
          echo "TZ=$TZ" >> $GITHUB_ENV
      
      - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
        run: |
          docker rmi `docker images -q`
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /usr/lib/jvm /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-1804)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "${{ env.TZ }}"

      - name: æ‹‰å–æºç 
        run: |
          cd ${{ github.workspace }}
          git clone --depth 1 ${{ env.REPO_URL }} -b ${{ env.REPO_BRANCH }} openwrt
          useVersionInfo=$(git show -s --date=short --format="Author: %an<br/>date: %cd<br/>commit: %s<br/>commit hash: %H")
          echo "useVersionInfo=$useVersionInfo" >> $GITHUB_ENV
      
      - name: æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
        run: |
          cd ${{ github.workspace }}/openwrt

          if [ -f ${{ github.workspace }}/config/${{ github.event.inputs.target }}/diy1.sh ]; then
            chmod +x ${{ github.workspace }}/config/${{ github.event.inputs.target }}/diy1.sh
            /bin/bash ${{ github.workspace }}/config/${{ github.event.inputs.target }}/diy1.sh
          fi
      
      - name: æ›´æ–°feeds
        run: |
          cd ${{ github.workspace }}/openwrt

          ./scripts/feeds clean
          ./scripts/feeds update -a
          ./scripts/feeds install -a
      
      - name: è¡¥ä¸ã€è‡ªå®šä¹‰æ–‡ä»¶åŠè„šæœ¬
        run: |
          cd ${{ github.workspace }}/openwrt

          if [ -n "$(ls -A "${{ github.workspace }}/config/${{ github.event.inputs.target }}/patches" 2>/dev/null)" ]; then
            find "${{ github.workspace }}/config/${{ github.event.inputs.target }}/patches" -type f -name '*.patch' -print0 | sort -z | xargs -I % -t -0 -n 1 sh -c "cat '%'  | patch -d './' -p0 --forward" || true
          fi

          if [ -n "$(ls -A "${{ github.workspace }}/config/${{ github.event.inputs.target }}/files" 2>/dev/null)" ]; then
            cp -rf ${{ github.workspace }}/config/${{ github.event.inputs.target }}/files ${{ github.workspace }}/openwrt/files
          fi

          if [ -n "$(ls -A "${{ github.workspace }}/config/${{ github.event.inputs.target }}/diy" 2>/dev/null)" ]; then
            cp -Rf ${{ github.workspace }}/config/${{ github.event.inputs.target }}/diy/* ${{ github.workspace }}/openwrt/
          fi

          if [ -f ${{ github.workspace }}/config/${{ github.event.inputs.target }}/diy2.sh ]; then
            chmod +x ${{ github.workspace }}/config/${{ github.event.inputs.target }}/diy2.sh
            /bin/bash ${{ github.workspace }}/config/${{ github.event.inputs.target }}/diy2.sh
          fi
      
      - name: è½½å…¥é…ç½®
        run: |
          cd ${{ github.workspace }}/openwrt
          rm -f ${{ github.workspace }}/openwrt/.config
          mv ${{ github.workspace }}/config/${{ github.event.inputs.target }}/.config ${{ github.workspace }}/openwrt/
          make defconfig
      
      - name: å¼€å¯SSHé€šé“
        if: env.SSH_ACTIONS == 'true' || contains(github.event.action, 'ssh')
        uses: P3TERX/debugger-action@main
      
      - name: ä¸‹è½½ä¾èµ–
        run: |
          cd ${{ github.workspace }}/openwrt
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
      
      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd ${{ github.workspace }}/openwrt
          echo -e "$(nproc) thread compile"
          make -j$(nproc) 2>&1 | tee -a build.log || make -j1 V=s 2>&1 | tee -a build.log
          ls -la ${{ github.workspace }}/openwrt/bin/targets/*/*/
          echo "::set-output name=status::success"
          echo "RELEASE_NAME=$(TZ=UTC-8 date +'%Yå¹´%mæœˆ%då·-%Hç‚¹%Måˆ†')" >> $GITHUB_ENV
          echo "RELEASE_TAG=$(TZ=UTC-8 date +'%Y%m%d-%H%M')" >> $GITHUB_ENV
      
      - name: æ•´ç†æ–‡ä»¶
        id: organizer
        if: steps.compile.outputs.status == 'success' && !cancelled()
        run: |
          mkdir -p ${{ github.workspace }}/dist/Packages
          cd ${{ github.workspace }}/openwrt/bin/targets/*/*
          find -name "*.buildinfo*" | xargs -i mv -f {} ${{ github.workspace }}/dist/
          find -name "*.bin*" | xargs -i mv -f {} ${{ github.workspace }}/dist/
          find -name "*.manifest*" | xargs -i mv -f {} ${{ github.workspace }}/dist/
          find -name "*.gz*" | xargs -i mv -f {} ${{ github.workspace }}/dist/

          cp -r -f ${{ github.workspace }}/openwrt/bin/packages/*/*/*.ipk ${{ github.workspace }}/dist/Packages/
          cp -r -f ${{ github.workspace }}/openwrt/bin/targets/*/*/packages/*.ipk ${{ github.workspace }}/dist/Packages/

          rm -f ${{ github.workspace }}/dist/Packages.gz

          cd ${{ github.workspace }}

          if [ -f ${{ github.workspace }}/config/${{ github.event.inputs.target }}/organizer.sh ]; then
            chmod +x ${{ github.workspace }}/config/${{ github.event.inputs.target }}/organizer.sh
            /bin/bash ${{ github.workspace }}/config/${{ github.event.inputs.target }}/organizer.sh
          fi

          cd ${{ github.workspace }}/dist
          tar -czf Packages.tar.gz Packages
          rm -rf Packages
          sha256sum `ls -1 | sort` > sha256sums

          echo "::set-output name=status::success"
          echo "::set-env name=FIRMWARE::$PWD"
      
      - name: ä¸Šä¼ å¥¶ç‰›å¿«ä¼ åŠwebtransfer
        id: upload
        if: steps.organizer.outputs.status == 'success' && env.UPLOAD == 'true' && !cancelled()
        run: |
          curl -fsSL git.io/file-transfer | sh
          ./transfer cow --block 2621440 -s -p 64 --no-progress ${{ env.FIRMWARE }} 2>&1 | tee cowtransfer.log
          echo "::set-output name=cowtransfer::$(cat cowtransfer.log | grep https | cut -f3 -d" ")"
          curl -fsSL git.io/file-transfer | sh
          ./transfer wet -s -p 16 --no-progress ${{ env.FIRMWARE }} 2>&1 | tee wetransfer.log
          echo "::set-output name=wetransfer::$(cat wetransfer.log | grep https | cut -f3 -d" ")"
      
      - name: ç‰ˆæœ¬å‘å¸ƒ
        if: steps.organizer.outputs.status == 'success' && env.RELEASE == 'true' && !cancelled()
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        with:
          name: ${{ env.RELEASE_NAME }}  â¤ï¸ | ${{ github.event.inputs.target }}-OpenWrt è‡ªåŠ¨ç¼–è¯‘
          tag_name: ${{ env.RELEASE_TAG }}
          body: |
            â˜† æºç æ¥æº: ${{ env.REPO_URL }}
            â˜† æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}

            ğŸš€ å¥¶ç‰›å¿«ä¼ : ${{ steps.upload.outputs.cowtransfer }}
            ğŸ¤ WeTransfer: ${{ steps.upload.outputs.wetransfer }}

            âœ¨ å½“å‰æºç ç‰ˆæœ¬:

            ${{ env.useVersionInfo }}
          files: ${{ github.workspace }}/dist/*

      - name: å¾®ä¿¡é€šçŸ¥
        if: steps.organizer.outputs.status == 'success' && env.WECHAT == 'true' && !cancelled()
        run: |
          [ ${{ steps.organizer.outputs.status}} == 'success' ] && curl https://sc.ftqq.com/${{ secrets.SCKEY }}.send?text=ğŸ‰${{ github.event.inputs.target }}ç¼–è¯‘å®ŒæˆğŸ˜‹|| curl https://sc.ftqq.com/${{ secrets.SCKEY }}.send?text=âŒ${{ github.event.inputs.target }}ç¼–è¯‘å¤±è´¥ğŸ˜‚